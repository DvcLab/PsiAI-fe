<script>
import Swal from "sweetalert2";
import LoaderContainer from "@/components/DvcAI/loader-container";

export default {
    props: {
        container: {
            type: Object,
            default: () => {}
        },
    },
    components: { LoaderContainer },
    data(){
        return {
            newInfo: null,
            websock: null,
            stompClient: '',
            timer: '',
            loadingState: false
        }
    },
    computed:{
        status() {
            const status = this.newInfo && this.newInfo.status ? this.newInfo.status : this.container.status;
            switch(status){
                case 'New':
                    return {
                        text: 'New',
                        theme: 'bg-primary'
                    };
                case 'Init':
                    return {
                        text: 'Init',
                        theme: 'bg-info'
                    };
                case 'Repo_Clone_Success':
                    return {
                        text: 'Repo_Clone_Success',
                        theme: 'bg-success'
                    };
                case 'Pip_Install_Success':
                    return {
                        text: 'Pip_Install_Success',
                        theme: 'bg-success'
                    };
                case 'Dataset_Load_Success':
                    return {
                        text: 'Dataset_Load_Success',
                        theme: 'bg-success'
                    };
                case 'Jupyterlab_Start_Success':
                    return {
                        text: 'Jupyterlab_Start_Success',
                        theme: 'bg-success'
                    };
                case 'Port_Forwarding_Success':
                    return {
                        text: 'Port_Forwarding_Success',
                        theme: 'bg-success'
                    };
                case 'Failure':
                    return {
                        text: 'Failure',
                        theme: 'bg-danger'
                    };
                case 'Deleted':
                    return {
                        text: 'Deleted',
                        theme: 'bg-secondary'
                    };
                case 'Running':
                    return {
                        text: 'Running',
                        theme: 'bg-success'
                    };
                default:
                    return {
                        text: 'NULL',
                        theme: 'bg-secondary'
                    }
            }
        },
        cpuUsage() {
            if(this.newInfo && this.newInfo.cpu_usage) return this.newInfo.cpu_usage;
            return this.container.cpu_usage;
        },
        cpuProgress() {
            let cpuUsage = this.container.cpu_usage;
            if(cpuUsage >= 30 && cpuUsage < 60) {
                return 'warning'
            } else if (cpuUsage >= 60) {
                return 'danger'
            } else {
                return 'success'
            }
        },
        memUsage() {
            if(this.newInfo && this.newInfo.mem_usage) return this.newInfo.mem_usage;
            return this.container.mem_usage;
        },
        memProgress() {
            let memUsage = this.container.mem_usage;
            if(memUsage >= 30 && memUsage < 60) {
                return 'warning'
            } else if (memUsage >= 60) {
                return 'danger'
            } else {
                return 'success'
            }
        },
        updateTime() {
            if(this.newInfo && this.newInfo.update_time) return this.newInfo.update_time;
            return this.container.update_time;
        },
        configFile() {
            let config = this.container.docker_compose_config
            let blob = new Blob([config], {type : 'application/x-yaml'});
            return URL.createObjectURL(blob);
        },
        isDel() {
            if(this.container.status === 'Deleted') return true;
            return false;
        }
    },
    mounted() {
        if(this.status.text !== 'Deleted') this.initWebSocket();
    },
    destroyed() {
        if(this.websock) this.websock.close();
    },
    methods: {
        // 打开JupyterLab页面
        openLab(href) {
            window.open(href, "_blank")
        },
        // 删除容器 
        delContainer() {
            this.loadingState = true;
            let id = this.container.id;
            this.$request.delete('containers/' + id)
            .then((res) => res.data)
            .then((res) => {
                if(res.code === 1) {
                    this.successMsg();
                } else {
                    this.errorMsg();
                }
                this.loadingState = false;
            })
            .catch((err) => {
                this.loadingState = false;
                console.err(err)
            })
        },
        // 初始化websocket
        initWebSocket() {

            const wsuri = process.env.VUE_APP_WS_URL + "_containers?id=" + this.container.id;
            this.websock = new WebSocket(wsuri, this.$keycloak.token);
            this.websock.onmessage = this.websocketonmessage;
            this.websock.onopen = this.websocketonopen;
            this.websock.onerror = this.websocketonerror;
            this.websock.onclose = this.websocketclose;

        },

        // 连接建立之后执行send方法发送数据
        websocketonopen() { 
        
        },

        // 连接建立失败重连
        websocketonerror() {
            this.initWebSocket()
        },

        // 数据接收
        websocketonmessage(res) {
            const message = JSON.parse(res.data);
            this.newInfo = message;
            console.log(message)
        },

        // 数据发送
        websocketsend(data) {
            this.websock.send(data)
        },

        // 关闭
        websocketclose(e) {
            console.log('websocket error', e)
        },

        // 容器创建成功提醒
        successMsg() {
            Swal.fire(
                "容器删除成功!",
                "",
                "success"
            ).then((res) => {
                if(res.isConfirmed) {
                    console.log('触发刷新列表函数')
                    this.$emit('update');
                }
            })
        },
        
        // 容器创建失败提醒
        errorMsg() {
            Swal.fire(
                "容器删除失败!",
                "",
                "error"
            )
        },
    }
}
</script>

<template>
<LoaderContainer :loading="loadingState">
    <div class="list-item-con">
        <div class="row align-items-center">
            <div class="col-12 col-md-4 mb-2">
                <h5 class="d-block text-truncate text-dark mb-0 list-item-name">
                    <i class="bx bx-code-block me-1"></i>
                    {{ container.id }}
                </h5>
            </div>
            <div class="col-12 col-md-4 mb-2">
                <span class="d-inline-block text-truncate">
                    <i class="bx bx-user me-1"></i>
                    {{ container.user.username }}
                </span>
            </div>
            <div class="col-12 col-md-4 mb-2">
                <div class="float-end d-none d-md-block">
                    <span class="badge me-2"
                        :class="status.theme"
                    >
                        {{ status.text }}
                    </span>
                    <span class="text-success">{{ updateTime | moment('YYYY-MM-DD HH:mm:ss') }}</span>
                </div>
                <div class="float-start d-md-none">
                    <span class="badge me-2"
                        :class="status.theme"
                    >
                        {{ status.text }}
                    </span>
                    <span class="text-success">{{ updateTime | moment('YYYY-MM-DD HH:mm:ss') }}</span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-2 mb-2">
                <span class="badge rounded-pill bg-primary me-2">
                    <i class="bx bx-chip me-1"></i>内核
                </span> {{ container.cpus }}
            </div>
            <div class="col-6 col-md-2 mb-2">
                <span class="badge rounded-pill bg-primary me-2">
                    <i class="bx bx-grid-alt me-1"></i>内存
                </span> {{ container.mem }}GB
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-4 mb-2">
                <p class="mb-0">CPU使用</p>
                <b-progress :value="cpuUsage" :max="100" :variant="cpuProgress"></b-progress>
            </div>
            <div class="col-12 col-md-4 mb-2">
                <p class="mb-0">内存使用</p>
                <b-progress :value="memUsage" :max="100" :variant="memProgress"></b-progress>
            </div>
            <div class="col-12 col-md-4">
                <div class="float-end">
                    <ul v-if="!isDel" class="list-inline mb-0 font-size-20">
                        <li class="list-inline-item">
                            <a
                                :href="configFile"
                                class="text-primary p-1"
                                download="docker-compose-config"
                            >
                                <i class="bx bx-cloud-download"></i>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a
                                :href="container.jupyter_url"
                                class="text-primary p-1"
                            >
                                <i class="bx bx-code-block"></i>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a
                                class="text-danger p-1"
                                href="javascript:void(0)" 
                                @click="delContainer"
                            >
                                <i class="bx bxs-trash"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</LoaderContainer>
</template>
